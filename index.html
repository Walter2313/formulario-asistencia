<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Confirmaci√≥n de Asistencia</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(to bottom, #004B87, #002d50);
    color: white;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: start;
  }

  .container {
    width: 90%;
    max-width: 500px;
    margin-top: 30px;
    padding: 25px;
    background-color: rgba(255, 255, 255, 0.1); /* transparencia */
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    backdrop-filter: blur(8px);
    box-sizing: border-box;
  }

  h2, h3 {
    text-align: center;
    margin: 0;
    padding-bottom: 10px;
  }

  h2 {
    font-size: 24px;
    color: #FFD100;
  }

  h3 {
    font-size: 18px;
    color: #ffffff;
    font-weight: 500;
  }

  input, select, button {
    width: 100%;
    margin-top: 12px;
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    box-sizing: border-box;
    font-family: inherit;
  }

  input, select {
    background-color: #f5f5f5;
    color: #002B36;
  }

  select option {
    color: #002B36;
  }

  button {
    background-color: #C8102E;
    color: white;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  button:hover {
    background-color: #a20e24;
  }

  .card {
    background-color: #FFD100;
    color: #002B36;
    padding: 20px;
    margin-top: 20px;
    border-radius: 12px;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .success {
    background-color: #00e676;
    color: #003c1d;
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
  }

  .error {
    background-color: #ff5252;
    color: #fff;
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
  }

  .hidden {
    display: none;
  }

  @media (max-width: 480px) {
    h2 {
      font-size: 20px;
    }

    h3 {
      font-size: 16px;
    }

    input, select, button {
      font-size: 15px;
      padding: 12px;
    }

    .card {
      padding: 15px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h2 style="text-align: center;">
  <i class="fas fa-check-circle"></i> Confirmaci√≥n de Asistencia
</h2>
<h3 style="font-weight: 600; color: #FFD100; text-align: center;">
  Servicio de Tutor√≠a ‚Äì Bienestar Universitario
</h3>
   <!-- Campo para buscar -->
<input type="text" id="identificacionBusqueda" placeholder="Ingrese su identificaci√≥n">

<!-- Campo oculto que se mostrar√° solo en el registro (y estar√° bloqueado) -->
<input type="text" id="identificacion" class="hidden" readonly style="background-color:#ddd;" placeholder="Identificaci√≥n registrada">

    <button onclick="buscar()"><i class="fas fa-search"></i> Buscar</button>
    <div id="cargando" class="hidden" style="margin-top: 20px;">
  <p style="background:#FFD100; color:#002B36; padding:10px; border-radius:8px; text-align:center;">
    <i class="fas fa-spinner fa-spin"></i> Buscando en la base de datos...
  </p>
</div>

<div id="noEncontrado" class="error hidden">
  <i class="fas fa-exclamation-triangle"></i> Persona no encontrada en la base de datos.
</div>

    <!-- Mensajes -->
    <div id="mensaje" class="success hidden">¬°Asistencia confirmada con √©xito!</div>
    <div id="mensajeError" class="error hidden">‚ö†Ô∏è Error en el proceso.</div>

    <!-- Formulario de asistencia -->
    <div id="formAsistencia" class="card hidden">
      <div id="datosPersona"></div>
      
      <div id="campoGrupo">
      <label>Grupo Prioritario</label>
      <select id="grupo">
        <option value="">Seleccione</option>
        <option>Ind√≠gena</option>
        <option>Afrodescendiente</option>
        <option>Persona con discapacidad</option>
        <option>V√≠ctima del conflicto armado</option>
        <option>Comunidad LGBTIQ+</option>
        <option>Habitante de frontera</option>
        <option>Ninguno</option>
      </select>
     </div>

      <label>Servicio</label>
        <select id="servicio" onchange="cargarActividades()">
        <option value="">Seleccione</option>
        <option>TUTOR√çAS</option>
      </select>

      <label>Actividad</label>
        <select id="actividad">
        <option value="">Seleccione</option>
      </select>

      <div id="campoAsignatura" class="hidden">
  <label>Asignatura</label>
  <select id="asignatura"></select>
</div>


<div id="campoResponsable" class="hidden">
  <label>Responsable</label>
  <input type="text" id="responsable" 
         placeholder="Escriba el nombre del responsable" 
         oninput="this.value = this.value.toUpperCase();">
</div>

<div id="campoTema" class="hidden">
  <label>Tema</label>
  <input type="text" id="tema" 
         placeholder="Escriba el tema tratado" 
         oninput="this.value = this.value.toUpperCase();">
</div>




      <button id="btnConfirmar" onclick="confirmarAsistencia()"><i class="fas fa-check"></i> Confirmar Asistencia</button>
    </div>

   

    </div>
  </div>
  

  <script>

    const actividadSelect = document.getElementById("actividad");
const asignaturaSelect = document.getElementById("asignatura");

actividadSelect.onchange = function () {
  const actividad = this.value;

  // Limpiar asignaturas
  asignaturaSelect.innerHTML = '<option value="">Seleccione</option>';

  // Llamar de nuevo las materias del estudiante
  if (actividad) {
    google.script.run.withSuccessHandler(function(asignaturas) {
      asignaturas.forEach(mat => {
        const option = document.createElement("option");
        option.value = mat.id;
        option.textContent = mat.nombre;
        asignaturaSelect.appendChild(option);
      });
    }).obtenerMateriasPorPrograma(document.getElementById("programa").value, document.getElementById("identificacion").value);
  }
};





    let persona = null;

    function buscar() {
  const id = document.getElementById("identificacionBusqueda").value.trim();

  if (!id || !/^\d+$/.test(id)) {
    // üîÑ Limpiar formularios y datos anteriores
    
    document.getElementById("formAsistencia").classList.add("hidden");
    document.getElementById("mensaje").classList.add("hidden");
    document.getElementById("mensajeError").classList.add("hidden");
    document.getElementById("noEncontrado").classList.add("hidden");
    document.getElementById("datosPersona").innerHTML = "";

    // üí° Limpiar campos de servicio y actividad
    document.getElementById("grupo").value = "";
    document.getElementById("servicio").value = "";
    document.getElementById("actividad").innerHTML = '<option value="">Seleccione</option>';

    persona = null;

    mostrarError("‚ö†Ô∏è Ingrese solo n√∫meros en la identificaci√≥n.");
    return;
  }

  // üîÑ Limpiar mensajes anteriores y mostrar cargando
  document.getElementById("cargando").classList.remove("hidden");
  
  document.getElementById("formAsistencia").classList.add("hidden");
  document.getElementById("mensaje").classList.add("hidden");
  document.getElementById("mensajeError").classList.add("hidden");
  document.getElementById("noEncontrado").classList.add("hidden");

  // üí° Limpiar campos de servicio y actividad al iniciar b√∫squeda
  document.getElementById("grupo").value = "";
  document.getElementById("servicio").value = "";
  document.getElementById("actividad").innerHTML = '<option value="">Seleccione</option>';

  google.script.run.withSuccessHandler(res => {
    document.getElementById("cargando").classList.add("hidden");

    if (res.encontrado) {
      persona = res.datos;
      mostrarFormularioAsistencia();
    } else {
      
      document.getElementById("noEncontrado").classList.remove("hidden");
    }
  }).buscarPersona(id);
}

    function mostrarFormularioAsistencia() {
  
  document.getElementById("formAsistencia").classList.remove("hidden");

  // Grupo prioritario
  if (persona.grupoPriorizado) {
    document.getElementById("campoGrupo").classList.add("hidden");
    document.getElementById("grupo").value = persona.grupoPriorizado;
    document.getElementById("grupo").classList.add("hidden");
  } else {
    document.getElementById("campoGrupo").classList.remove("hidden");
    document.getElementById("grupo").value = "";
    document.getElementById("grupo").classList.remove("hidden");
  }

  document.getElementById("mensaje").classList.add("hidden");
  document.getElementById("mensajeError").classList.add("hidden");
  document.getElementById("noEncontrado").classList.add("hidden");

  let html = "";
  html += `<p><strong>üßç‚Äç‚ôÇÔ∏è Nombres Completos:</strong> ${persona.nombre}</p>`;
  if (persona.sexo) html += `<p><strong>üöª Sexo:</strong> ${persona.sexo}</p>`;
  if (persona.grupoPriorizado) html += `<p><strong>üß¨ Grupo Priorizado:</strong> ${persona.grupoPriorizado}</p>`;
  if (persona.estamento) html += `<p><strong>üè´ Estamento:</strong> ${persona.estamento}</p>`;

  // ‚úÖ Programas: si hay m√°s de uno, mostrar selector
  if (persona.programas && persona.programas.length > 1) {
  html += `<p><strong>üéì Programa:</strong> 
    <select id="programaSelector">
      <option value="">Seleccione el programa</option>
      ${persona.programas.map(p => `<option value="${p.programa}">${p.programa}</option>`).join('')}
    </select>
  </p>
  <p><strong>üìä Semestre:</strong> <span id="semestreMostrar">Seleccione un programa</span></p>`;
} 
else if (persona.programas && persona.programas.length === 1) {
  persona.programa = persona.programas[0].programa;
  persona.semestre = persona.programas[0].semestre;
  html += `<p><strong>üéì Programa:</strong> ${persona.programa}</p>`;
  html += `<p><strong>üìä Semestre:</strong> ${persona.semestre}</p>`;
}

  if (persona.dependencia) html += `<p><strong>üè¢ Dependencia:</strong> ${persona.dependencia}</p>`;
  if (persona.facultad) html += `<p><strong>üèõ Facultad:</strong> ${persona.facultad}</p>`;
  
  if (persona.correo) html += `<p><strong>üì® Correo:</strong> ${persona.correo}</p>`;
  if (persona.telefono) html += `<p><strong>üì± Tel√©fono:</strong> ${persona.telefono}</p>`;

  document.getElementById("datosPersona").innerHTML = html;

  // Si hay selector de programas, escuchar cambio
  const selProg = document.getElementById("programaSelector");
if (selProg) {
  selProg.addEventListener("change", function () {
    const progSeleccionado = this.value;
    const progObj = persona.programas.find(p => p.programa === progSeleccionado);

    if (progObj) {
      persona.programa = progObj.programa;
      persona.semestre = progObj.semestre;
      document.getElementById("semestreMostrar").textContent = progObj.semestre || "No registrado";
    }

    // Limpiar materias y cargarlas para el programa elegido
    document.getElementById("asignatura").innerHTML = '<option value="">Seleccione</option>';
    if (persona.programa) {
      google.script.run.withSuccessHandler(function (materias) {
        const select = document.getElementById("asignatura");
        select.innerHTML = '<option value="">Seleccione</option>';
        materias.forEach(m => {
          const option = document.createElement("option");
          option.value = `${m.id} - ${m.nombre}`;
          option.textContent = m.nombre;
          select.appendChild(option);
        });
      }).obtenerMateriasPorPrograma(persona.programa, persona.identificacion);
    }
  });
}

  hacerScrollAElemento("formAsistencia");

  // Limpiar campos adicionales
  document.getElementById("grupo").value = "";
  document.getElementById("servicio").value = "";
  document.getElementById("actividad").innerHTML = '<option value="">Seleccione</option>';
  document.getElementById("asignatura").innerHTML = '<option value="">Seleccione</option>';
  document.getElementById("responsable").value = "";
  document.getElementById("tema").value = "";
}

    

    function mostrarCampos() {
      const estamento = document.getElementById("estamento").value;
      document.getElementById("campoPrograma").classList.add("hidden");
      document.getElementById("campoSemestre").classList.add("hidden");
      document.getElementById("campoDependencia").classList.add("hidden");
      document.getElementById("campoFacultad").classList.add("hidden");
      if (estamento === "Estudiante") {
        document.getElementById("campoPrograma").classList.remove("hidden");
        document.getElementById("campoSemestre").classList.remove("hidden");
      } else if (estamento === "Egresado") {
        document.getElementById("campoPrograma").classList.remove("hidden");
      } else if (estamento === "Funcionario") {
        document.getElementById("campoDependencia").classList.remove("hidden");
      } else if (estamento === "Docente") {
        document.getElementById("campoFacultad").classList.remove("hidden");
      }

    }

    

    function confirmarAsistencia() {
  const btn = document.getElementById("btnConfirmar");
  const selectAsignatura = document.getElementById("asignatura");
  let idAsignatura = "";
  let nombreAsignatura = "";

  if (selectAsignatura && selectAsignatura.value.includes(" - ")) {
  const partes = selectAsignatura.value.split(" - ");
  idAsignatura = partes[0].trim();
  nombreAsignatura = partes.slice(1).join(" - ").trim();
   } else {
  nombreAsignatura = selectAsignatura?.value || "";
   }
  
  if (btn.disabled) return; // prevenir m√∫ltiples clics

  const info = {
  identificacion: persona.identificacion,
  nombre: persona.nombre,
  sexo: persona.sexo,
  grupoPriorizado: document.getElementById("grupo").value,
  estamento: persona.estamento,
  programa: persona.programa || "",
  dependencia: persona.dependencia || "",
  facultad: persona.facultad || "",
  semestre: persona.semestre || "",
  correo: persona.correo,
  telefono: persona.telefono,
  servicio: document.getElementById("servicio").value,
  actividad: document.getElementById("actividad").value,
  idAsignatura: idAsignatura,
  asignatura: nombreAsignatura,
  responsable: document.getElementById("responsable")?.value || "",
  tema: document.getElementById("tema")?.value.trim() || ""
};



  // Validar campos b√°sicos (estos siempre)
if (!info.grupoPriorizado || !info.servicio || !info.actividad) {
  mostrarError("‚ö†Ô∏è Complete todos los campos obligatorios.");
  return;
}

// Si la actividad es tutor√≠a planificada u ocasional ‚Üí validar asignatura, tema y responsable
if (
  (info.actividad === "TUTOR√çA PLANIFICADA" || info.actividad === "TUTOR√çA OCASIONAL") &&
  (!info.asignatura || !info.responsable || !info.tema || info.asignatura.toLowerCase() === "cargando...")
) {
  mostrarError("‚ö†Ô∏è Debe completar asignatura, responsable y tema para esta tutor√≠a.");
  return;
}

  


  // üîí Desactivar bot√≥n y mostrar spinner
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';

  const grupoSeleccionado = document.getElementById("grupo").value;
   const debeActualizarGrupo = !persona.grupoPriorizado && grupoSeleccionado;

  google.script.run.withSuccessHandler(function (res) {
    // ‚úÖ Reactivar bot√≥n
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Asistencia';

    if (res === "ok") {
      if (debeActualizarGrupo) {
        google.script.run.actualizarGrupoPriorizado(info.identificacion, grupoSeleccionado);
      }
      document.getElementById("mensaje").classList.remove("hidden");
      document.getElementById("formAsistencia").classList.add("hidden");

      document.getElementById("mensajeError").classList.add("hidden");

      document.getElementById("identificacion").value = "";
      document.getElementById("grupo").value = "";
      document.getElementById("servicio").value = "";
      document.getElementById("actividad").value = "";
      document.getElementById("actividad").innerHTML = '<option value="">Seleccione</option>';
      document.getElementById("asignatura").innerHTML = '<option value="">Seleccione</option>';
      document.getElementById("responsable").value = "";
      document.getElementById("tema").value = ""
      
      

      document.getElementById("identificacionBusqueda").value = "";
      document.getElementById("identificacionBusqueda").classList.remove("hidden");
      document.getElementById("identificacion").classList.add("hidden");

      persona = null;

      setTimeout(() => {
        document.getElementById("mensaje").classList.add("hidden");
      }, 5000);
    } else {
      mostrarError("‚ö†Ô∏è No se pudo guardar la asistencia.");
    }
  }).guardarAsistencia(info);
}

function mostrarError(mensaje) {
  const error = document.getElementById("mensajeError");
  error.innerText = mensaje;
  error.classList.remove("hidden");
}


const actividadesPorServicio = {
  "TUTOR√çAS": [
    'TUTOR√çA PLANIFICADA',
    'TUTOR√çA OCASIONAL',
    'FORMACI√ìN PEDAG√ìGICA A LOS ESTUDIANTES TUTORES',
    'ACTO DE EXALTACION A ESTUDIANTES INSIGNE Y TUTORES DESTACADOS'
  ]
};

function cargarActividades() {
  const servicioSeleccionado = document.getElementById("servicio").value;
  const actividadSelect = document.getElementById("actividad");

  // Limpiar actividades
  actividadSelect.innerHTML = '<option value="">Seleccione</option>';

  if (actividadesPorServicio[servicioSeleccionado]) {
    actividadesPorServicio[servicioSeleccionado].forEach(act => {
      const option = document.createElement("option");
      option.value = act;
      option.text = act;
      actividadSelect.appendChild(option);
    });
  }

  // Ocultar campos por defecto y limpiar valores
  document.getElementById("campoAsignatura").classList.add("hidden");
  document.getElementById("campoResponsable").classList.add("hidden");
  document.getElementById("campoTema").classList.add("hidden");

  document.getElementById("asignatura").innerHTML = '<option value="">Seleccione</option>';
  document.getElementById("responsable").value = "";
  document.getElementById("tema").value = "";

  // Detectar cambio en actividad
  actividadSelect.onchange = function () {
    const actividad = this.value;

    // Limpiar campos al cambiar actividad
    document.getElementById("asignatura").innerHTML = '<option value="">Seleccione</option>';
    document.getElementById("responsable").value = "";
    document.getElementById("tema").value = "";

    if (actividad === "TUTOR√çA PLANIFICADA") {
      document.getElementById("campoAsignatura").classList.remove("hidden");
      document.getElementById("campoResponsable").classList.remove("hidden");
      document.getElementById("campoTema").classList.remove("hidden");
      cargarAsignaturasPlanificadas();
    } else if (actividad === "TUTOR√çA OCASIONAL") {
      document.getElementById("campoAsignatura").classList.remove("hidden");
      document.getElementById("campoResponsable").classList.remove("hidden");
      document.getElementById("campoTema").classList.remove("hidden");
      cargarAsignaturasDelEstudiante();
    } else {
      document.getElementById("campoAsignatura").classList.add("hidden");
      document.getElementById("campoResponsable").classList.add("hidden");
      document.getElementById("campoTema").classList.add("hidden");
    }
  };
}

function cargarAsignaturasPlanificadas() {
  const select = document.getElementById("asignatura");
  select.innerHTML = '<option>Cargando...</option>';

  google.script.run.withSuccessHandler(function (materias) {
    select.innerHTML = '<option value="">Seleccione</option>';
    materias.forEach(m => {
      const option = document.createElement("option");
      option.value = `${m.id} - ${m.nombre}`;
      option.textContent = m.nombre;
      select.appendChild(option);
    });
  }).obtenerMateriasPorPrograma(persona.programa, persona.identificacion);
}



function cargarAsignaturasDelEstudiante() {
  const select = document.getElementById("asignatura");
  select.innerHTML = '<option>Cargando...</option>';

  google.script.run.withSuccessHandler(function (materias) {
    select.innerHTML = '<option value="">Seleccione</option>';
    materias.forEach(m => {
      const option = document.createElement("option");
      option.value = `${m.id} - ${m.nombre}`;   // ‚úÖ Este value servir√° para extraer luego el ID y el nombre
      option.textContent = m.nombre;
      select.appendChild(option);
    });
  }).obtenerMateriasPorPrograma(persona.programa, persona.identificacion);
}


function cambiarPrograma() {
  const idx = document.getElementById("selectorPrograma").value;
  if (idx === "") {
    document.getElementById("semestreActual").innerText = "";
    return;
  }

  persona.programa = persona.programas[idx].programa;
  persona.semestre = persona.programas[idx].semestre;

  document.getElementById("semestreActual").innerText = persona.semestre || "No registrado";
}

function regresarBusqueda() {
  

  // Limpiar el campo de identificaci√≥n bloqueada
  document.getElementById("identificacion").value = "";
  document.getElementById("identificacion").classList.add("hidden");

  // Volver a mostrar el campo de b√∫squeda
  document.getElementById("identificacionBusqueda").classList.remove("hidden");
  document.getElementById("identificacionBusqueda").value = "";

  // Limpiar mensajes
  document.getElementById("mensaje").classList.add("hidden");
  document.getElementById("mensajeError").classList.add("hidden");
  document.getElementById("noEncontrado").classList.add("hidden");

  // Resetear persona
  persona = null;
}


</script>
  </script>
</body>
</html>